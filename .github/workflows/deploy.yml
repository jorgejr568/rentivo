name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libmysqlclient-dev

      - name: Install dependencies
        run: pip install -e ".[test]"

      - name: Run tests
        run: python -m pytest tests/ -n auto -v --cov=rentivo --cov=web --cov-report=term-missing --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Trigger deploy
        env:
          DEPLOY_TRIGGER_URL: ${{ secrets.DEPLOY_TRIGGER_URL }}
        run: |
          for i in 1 2 3 4 5; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_TRIGGER_URL")
            echo "Attempt $i: HTTP $status"
            if [ "$status" = "200" ]; then
              echo "Deploy triggered successfully"
              exit 0
            fi
            [ "$i" -lt 5 ] && sleep 5
          done
          echo "Deploy failed after 5 attempts"
          exit 1

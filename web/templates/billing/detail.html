{% extends "base.html" %}

{% block title %}{{ billing.name }} - Rentivo{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-info">
        <h2 class="page-title">{{ billing.name }}</h2>
        {% if billing.description %}
        <p class="page-subtitle">{{ billing.description }}</p>
        {% endif %}
    </div>
    <div class="page-actions">
        {% if role in ("owner", "admin", "manager") %}
        <a href="/billings/{{ billing.uuid }}/bills/generate" class="btn btn--primary">Gerar Fatura</a>
        {% endif %}
        {% if role in ("owner", "admin") %}
        <a href="/billings/{{ billing.uuid }}/edit" class="btn">Editar</a>
        {% endif %}
    </div>
</div>

{% if billing.pix_key %}
<div class="detail-meta">
    <div class="detail-meta-item">
        <strong>Chave PIX:</strong> <span class="text-mono">{{ billing.pix_key }}</span>
    </div>
</div>
{% endif %}

<div class="panel">
    <div class="panel-head">
        <h5>Itens da Cobrança</h5>
    </div>
    <div class="data-table-wrap">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th class="text-center">Tipo</th>
                    <th class="text-right">Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for item in billing.items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-center">
                        {% if item.item_type.value == "fixed" %}
                        <span class="tag tag--fixed">Fixo</span>
                        {% else %}
                        <span class="tag tag--variable">Variável</span>
                        {% endif %}
                    </td>
                    <td class="text-right text-mono">
                        {% if item.item_type.value == "fixed" %}
                        {{ format_brl(item.amount) }}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="panel">
    <div class="panel-head">
        <h5>Faturas</h5>
    </div>
    {% if bills %}
    <div class="data-table-wrap">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Referência</th>
                    <th class="text-right">Total</th>
                    <th class="text-center">Vencimento</th>
                    <th class="text-center">Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for bill in bills %}
                <tr>
                    <td><a href="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}">{{ format_month(bill.reference_month) }}</a></td>
                    <td class="text-right text-mono">{{ format_brl(bill.total_amount) }}</td>
                    <td class="text-center">{{ bill.due_date or "—" }}</td>
                    <td class="text-center">
                        {% if bill.payment_status == "paid" %}
                        <span class="tag tag--paid">Pago</span>
                        {% elif bill.payment_status == "overdue" %}
                        <span class="tag tag--overdue">Vencido</span>
                        {% else %}
                        <span class="tag tag--pending">Pendente</span>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        <a href="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}" class="btn btn--sm">Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>Nenhuma fatura gerada.</p>
    </div>
    {% endif %}
</div>

{% if user_orgs %}
<div class="panel">
    <div class="panel-head">
        <h5>Transferir para Organização</h5>
    </div>
    <div class="panel-body">
        <form method="post" action="/billings/{{ billing.uuid }}/transfer">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="item-grid">
                <div class="field mb-0">
                    <select class="field-select" name="organization_id" required>
                        <option value="">Selecione...</option>
                        {% for org in user_orgs %}
                        <option value="{{ org.id }}">{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button type="submit" class="btn btn--primary"
                            onclick="return confirm('Tem certeza? Esta ação não pode ser desfeita.')">Transferir</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if role in ("owner", "admin") %}
<div class="mt-2">
    <form method="post" action="/billings/{{ billing.uuid }}/delete"
          onsubmit="return confirm('Tem certeza que deseja excluir esta cobrança?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn btn--sm btn--danger">Excluir Cobrança</button>
    </form>
</div>
{% endif %}
{% endblock %}

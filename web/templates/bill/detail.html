{% extends "base.html" %}

{% block title %}Fatura {{ format_month(bill.reference_month) }} - Landlord{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            Fatura - {{ format_month(bill.reference_month) }}
            {% if bill.payment_status == "paid" %}
            <span class="badge badge-paid">Pago</span>
            {% elif bill.payment_status == "overdue" %}
            <span class="badge badge-overdue">Vencido</span>
            {% else %}
            <span class="badge badge-pending">Pendente</span>
            {% endif %}
        </h2>
        <p class="text-muted mb-0">Cobrança: {{ billing.name }}</p>
    </div>
    <div>
        {% if bill.pdf_path %}
        <a href="/bills/{{ bill.uuid }}/invoice" target="_blank" class="btn btn-primary">Ver PDF</a>
        {% endif %}
        <form method="post" action="/bills/{{ bill.uuid }}/regenerate-pdf" class="d-inline">
            <button type="submit" class="btn btn-outline-primary">Regenerar PDF</button>
        </form>
        <form method="post" action="/bills/{{ bill.uuid }}/toggle-paid" class="d-inline">
            {% if bill.paid_at %}
            <button type="submit" class="btn btn-outline-secondary">Desmarcar Pagamento</button>
            {% else %}
            <button type="submit" class="btn btn-outline-primary">Marcar como Pago</button>
            {% endif %}
        </form>
        <a href="/bills/{{ bill.uuid }}/edit" class="btn btn-outline-secondary">Editar</a>
    </div>
</div>

<div class="card mb-4">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th class="text-center">Tipo</th>
                    <th class="text-end">Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for item in bill.line_items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-center">
                        {% if item.item_type.value == "fixed" %}
                        <span class="badge badge-fixed">Fixo</span>
                        {% elif item.item_type.value == "variable" %}
                        <span class="badge badge-variable">Variável</span>
                        {% else %}
                        <span class="badge badge-extra">Extra</span>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ format_brl(item.amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-active">
                    <td colspan="2" class="text-end"><strong>Total</strong></td>
                    <td class="text-end"><strong>{{ format_brl(bill.total_amount) }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{% if bill.due_date %}
<p><strong>Vencimento:</strong> {{ bill.due_date }}</p>
{% endif %}

{% if bill.paid_at %}
<p><strong>Pago em:</strong> {{ bill.paid_at.strftime("%d/%m/%Y %H:%M") }}</p>
{% endif %}

{% if bill.notes %}
<div class="card mb-4">
    <div class="card-header"><h6 class="mb-0">Observações</h6></div>
    <div class="card-body">{{ bill.notes }}</div>
</div>
{% endif %}

<div class="d-flex gap-2">
    <a href="/billings/{{ billing.uuid }}" class="btn btn-outline-secondary">Voltar</a>
    <form method="post" action="/bills/{{ bill.uuid }}/delete"
          onsubmit="return confirm('Tem certeza que deseja excluir esta fatura?')">
        <button type="submit" class="btn btn-outline-danger">Excluir Fatura</button>
    </form>
</div>
{% endblock %}
